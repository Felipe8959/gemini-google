import os
import zipfile
import win32com.client
import shutil

# Configurações
email_subject = 'PROT_080_OUV_USUARIOS - Arquivo para VOX'
save_directory = r'C:\caminho\para\diretorio\local'
network_path = r'\\servidor\pasta_compartilhada'
network_username = 'usuario'
network_password = 'senha'

def download_attachment(subject, save_folder):
    # Conecta ao Outlook
    outlook = win32com.client.Dispatch('Outlook.Application')
    mapi = outlook.GetNamespace('MAPI')
    inbox = mapi.GetDefaultFolder(6)  # 6 é a pasta da caixa de entrada
    
    # Acessando uma subpasta chamada "Processados" dentro da caixa de entrada
    subfolder = inbox.Folders['Processados']  # Nome da subpasta
    
    # Ordenar os emails por data, do mais recente ao mais antigo
    messages = subfolder.Items
    messages.Sort("[ReceivedTime]", True)

    # Iterar pelo email mais recente primeiro
    for message in messages:
        if message.Subject == subject:
            attachments = message.Attachments
            for attachment in attachments:
                if attachment.FileName.endswith('.zip'):
                    zip_path = os.path.join(save_folder, attachment.FileName)
                    attachment.SaveAsFile(zip_path)
                    return zip_path
    return None

def extract_zip(zip_path, extract_to_folder):
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_to_folder)

def upload_file_to_network(file_path, network_path):
    # Tenta copiar o arquivo para o caminho da rede
    try:
        shutil.copy(file_path, network_path)
        print(f'Arquivo {os.path.basename(file_path)} copiado para {network_path}.')
    except Exception as e:
        print(f'Erro ao copiar o arquivo: {e}')

def main():
    zip_file_path = download_attachment(email_subject, save_directory)
    if zip_file_path:
        extract_zip(zip_file_path, save_directory)
        for root, _, files in os.walk(save_directory):
            for file in files:
                if file.endswith('.txt'):
                    file_path = os.path.join(root, file)
                    upload_file_to_network(file_path, network_path)
                    print(f'Arquivo {file} enviado para o diretório compartilhado.')
    else:
        print('Nenhum anexo encontrado com o assunto especificado.')

if __name__ == '__main__':
    main()
