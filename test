import os
import zipfile
import win32com.client

# Configurações
email_subject = 'PROT_080_OUV_USUARIOS - Arquivo para VOX'
save_directory = r'C:\caminho\para\diretorio\compartilhado'
username = 'usuario'
password = 'senha'

def download_attachment(subject, save_folder):
    # Conecta ao Outlook
    outlook = win32com.client.Dispatch('Outlook.Application')
    mapi = outlook.GetNamespace('MAPI')
    inbox = mapi.GetDefaultFolder(6)  # 6 é a pasta da caixa de entrada
    messages = inbox.Items
    
    for message in messages:
        if message.Subject == subject:
            attachments = message.Attachments
            for attachment in attachments:
                if attachment.FileName.endswith('.zip'):
                    zip_path = os.path.join(save_folder, attachment.FileName)
                    attachment.SaveAsFile(zip_path)
                    return zip_path
    return None

def extract_zip(zip_path, extract_to_folder):
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_to_folder)
        
def upload_file_to_shared_directory(file_path, save_directory):
    # Para SMB ou SFTP, você pode usar bibliotecas como pysmb ou paramiko.
    # Exemplo com pysmb (deve instalar: pip install pysmb):
    from smb.SMBConnection import SMBConnection
    
    conn = SMBConnection(username, password, 'local_machine', 'remote_server', use_ntlm_v2=True)
    conn.connect('remote_server_ip', 139)
    with open(file_path, 'rb') as file_obj:
        conn.storeFile('shared_directory', os.path.basename(file_path), file_obj)

def main():
    zip_file_path = download_attachment(email_subject, save_directory)
    if zip_file_path:
        extract_zip(zip_file_path, save_directory)
        for root, _, files in os.walk(save_directory):
            for file in files:
                if file.endswith('.txt'):
                    file_path = os.path.join(root, file)
                    upload_file_to_shared_directory(file_path, save_directory)
                    print(f'Arquivo {file} enviado para o diretório compartilhado.')
    else:
        print('Nenhum anexo encontrado com o assunto especificado.')

if __name__ == '__main__':
    main()
